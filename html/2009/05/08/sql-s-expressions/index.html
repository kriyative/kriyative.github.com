<html lang="en"><head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><meta charset="UTF-8" /><meta name="description" /><meta content="clojure sql" name="keywords" /><meta content="Ram Krishnan" name="author" /><link href="/assets/favicon.ico" rel="icon" type="image/x-icon" /><link href="/assets/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="/default.css" rel="stylesheet" type="text/css" /><link href="/rss-feed" rel="alternate" title="kriyative" type="application/rss+xml" /><link href="http://fonts.googleapis.com/css?family=Snowburst+One" rel="stylesheet" type="text/css" /><link href="http://kriyative.github.com/2009/05/08/sql-s-expressions/" rel="canonical" /><title>sql and s-expressions</title></head><body><header id="banner"><div class="sleeve"><hgroup id="nameplate"><h1 id="title"><a href="/">kriyative</a></h1><h2 id="description"></h2></hgroup><nav id="toc"><ul id="menu"><li class="menu-item"><a href="/archives">Archives</a></li><li class="menu-item"><a href="/tags">Tags</a></li><li class="menu-item"><a href="/rss-feed">Subscribe</a></li></ul></nav></div></header><div id="main"><div class="sleeve"><div id="content"><article class="post format-standard"><header class="post-header"><h1 class="post-title">sql and s-expressions</h1><p class="post-meta">Posted on 08 May 2009</p></header><div class="post-content">
<p>On one of the Common Lisp projects I worked on (a very typical Web
app), I used the CLSQL library to integrate with a Postgres
database. CLSQL is itself an opensource version of the SQL package
which is part of Lispworks. One of the more interesting features of
this library was an s-expression based query language, which emitted
SQL query strings behind the scenes. So, for example:
</p>
<pre class="example">
(select [count 1]
        :from '([person])
        :where [and [= [role] +role-programmer+]
                [&lt; [age] 30]))
</pre>


<p>
would emit the following SQL (and actually runs the query):
</p>
<pre class="example">
SELECT COUNT(1) FROM person WHERE (role = 1 AND age &lt; 30)
</pre>


<p>
Nice. Just being able to write the WHERE clause as a readable
s-expression makes CLSQL worthwhile. Of course, it does much more than
just that.
</p>
<p>
Anyway, Clojure has a library in clojure-contrib, for integrating with
SQL databases using JDBC. But, as you can see from the examples on
that wiki page, SELECT, INSERT and UPDATE more or less require hand
built SQL query strings. So, I figured I'd try and emulate the CLSQL
approach using Clojure macrology. Here's what I was able to do:
</p>
<pre class="example">
(sql-select-stmt "count(1)"
                 :from '(person)
                 :where (sql-and (sql-= 'role +role-programmer+)
                                 (sql-&lt; 'age 30)))
</pre>


<p>
Not as concise as CLSQL (the "sql-" prefix interrupts the flow), but
perhaps the best we can do, considering Clojure doesn't have
programmable reader macros (at least not without serious
hackery). CLSQL cleverly uses reader macros to do interesting things
with expressions which are inside square brackets, like turning <code>[or ...]</code> into <code>(sql-or ...)</code>, and <code>[a-table-name]</code> into "a<sub>table</sub><sub>name</sub>"
etc.
</p>
<p>
Incidentally, <code>sql-select-stmt</code> doesn't run the query, just generates
the query string, which can be passed to <code>with-results</code>, like so:
</p>
<pre class="example">
(with-results rs
  (sql-select-stmt "count(1)"
                   :from from
                   :where where)
  (:count (first rs)))
</pre>


<p>
The code for the sql macros is a bit long to insert here, so I'm
thinking I'll create a <span style="text-decoration:underline;">cynojure</span> repo on github, and put all the
various bits of clojure code I create in there. I'll post about that
separately.
</p>
<p>
Peace.
</p></div><footer class="post-footer" /></article></div><aside id="sidebar"><section class="panel"><p><img id="profile-pic" src="http://www.gravatar.com/avatar/6dcf36ddd0aa73e04e125e3c10f6ff05.png" />Hi, I'm Ram Krishnan - a <a href="http://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a> programmer and software entrepreneur.</p></section><section class="panel"><h1>Links</h1><ul><li><a href="https://github.com/kriyative">Github</a></li><li><a href="http://www.ingeniousmonkey.com">IngeniousMonkey</a></li></ul><p>I sometimes post on <a href="http://twitter.com/funcall">twitter</a>.</p></section><section class="panel"><h1>Recent posts</h1><ul><li><a href="/2013/02/20/new-site/"> New Site</a></li><li><a href="/2012/07/28/emacs-for-clojure-2/">Emacs for Clojure - Part 2</a></li><li><a href="/2012/07/21/emacs-for-clojure-1/">Emacs for Clojure - Part 1</a></li><li><a href="/2011/03/26/ecl-for-ios-updated/">ECL for iOS update for ECL-11.1.1, Xocde 4, and SDK 4.3</a></li><li><a href="/2011/01/10/clojurejs-announcement/">clojurejs -- a Clojure (subset) to Javascript translator</a></li><li><a href="/2010/12/20/lisp-functions-ui-callbacks-ecl-ios/">Lisp functions as UI callbacks in ECL/iOS</a></li><li><a href="/2010/12/14/ecl-for-ios-updated/">ECL for iOS updated to work with SDK 4.2</a></li><li><a href="/2010/03/23/daily-org-agenda-reminder/">Displaying a daily Org-mode agenda reminder in Emacs</a></li><li><a href="/2010/02/10/snapshot-of-ecl-for-iphone/">Snapshot of ECL for iPhone</a></li><li><a href="/2010/01/29/my-other-lisp-blog/">my other lisp blog</a></li></ul></section></aside></div></div><footer id="addendum"><div class="sleeve"><p id="copyright">Copyright © 2012–2013 Ram Krishnan</p></div></footer></body></html>